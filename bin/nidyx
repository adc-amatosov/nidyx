#!/usr/bin/env ruby

require "optparse"
require "json"
require "nidyx"
require "nidyx/version"
require "nidyx/generator"
require "nidyx/output"

###
# help text
###

BANNER = <<END
usage: nidyx [-h] [--version]
       nidyx <schema> <class-prefix> [output-directory]
             [-j] [-a author] [-c company] [-p project]

END

DESC = <<END

Nidyx generates plain Objective-C models from JSON Schema. It can also generate
models with JSONModel support.

Examples
========

Bare minimum. Given a schema and a class prefix, generate models in the
current directory:

  $ nidyx example.json.schema ClassPrefix

Specify an ouput directory:

  $ nidyx example.json.schema ClassPrefix /path/to/output/directory

Generate models with JSONModel support and all optional documentation:

  $ nidyx example.json.schema ClassPrefix /path/to/output/directory \\
    -j -a "Your Name" -c "Company Name" -p "Project Name"

END

###
# option parsing
###

options = {}

opts = OptionParser.new do |o|
  o.banner = BANNER

  o.on("-j", "--json-model", "Generate with JSONModel support") do |j|
    options[:json_model] = j
  end

  o.on("-a", "--author AUTHOR", "Author's name") do |a|
    options[:author] = a
  end

  o.on("-c", "--company COMPANY", "Company's name") do |c|
    options[:company] = c
  end

  o.on("-p", "--project PROJECT", "Project's name") do |p|
    options[:project] = p
  end

  o.on("-h", "--help", "Print usage information") do
    puts o
    exit
  end

  o.on("--version", "Print version") do
    puts Nidyx::VERSION
    exit
  end

  o.separator DESC
end

begin
  opts.parse!
rescue OptionParser::InvalidOption => e
  puts e
  puts opts
  exit 1
end

if ARGV.size < 2
  puts "Too few arguments." unless ARGV.empty?
  puts opts
  exit
end

###
# generator
###

# Attempt to parse ARGV[0] as a file containing JSON. If anything fails, bail.
begin
  # TODO: validate this is legitimate JSON Schema
  schema = JSON.parse(IO.read(ARGV[0]))
rescue JSON::JSONError
  puts "Invalid JSON read from #{ARGV[0]}"
  exit 1
end

# Run the generator and store the models
gen = Nidyx::Generator.new(ARGV[1], options)
models = gen.spawn(schema)

Nidyx::Output.write(models, ARGV[2])
